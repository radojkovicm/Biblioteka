{% extends "base.html" %}
{% block title %}Rezervacije — Biblioteka{% endblock %}

{% block content %}
<div class="page-header">
    <h1 data-i18n="reservations">Rezervacije</h1>
    <button class="btn btn-primary" onclick="openModal('new-reservation-modal')" data-i18n="new_reservation">+ Nova rezervacija</button>
</div>

<div class="search-bar">
    <select id="reservation-filter" class="form-control" style="max-width:200px" onchange="loadReservations(this.value)">
        <option value="active" data-i18n="active_reservations">Aktivne</option>
        <option value="" data-i18n="all_reservations">Sve</option>
        <option value="waiting" data-i18n="waiting">Čekaju</option>
        <option value="notified" data-i18n="notified">Obavešteni</option>
        <option value="fulfilled" data-i18n="fulfilled">Ispunjene</option>
        <option value="cancelled" data-i18n="cancelled">Otkazane</option>
    </select>
</div>

<div class="card">
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th data-i18n="book_title">Knjiga</th>
                    <th data-i18n="members">Član</th>
                    <th data-i18n="queue_position">Red</th>
                    <th data-i18n="status_title">Status</th>
                    <th data-i18n="date">Datum</th>
                    <th data-i18n="actions">Akcije</th>
                </tr>
            </thead>
            <tbody id="reservations-tbody">
                <tr><td colspan="6" class="empty-state" data-i18n="loading">Učitavanje...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- New Reservation Modal -->
<div class="modal-overlay" id="new-reservation-modal">
    <div class="modal">
        <h2 data-i18n="new_reservation_title">Nova rezervacija</h2>
        <form onsubmit="saveNewReservation(event)">
            <input type="hidden" id="res-book-id">
            <input type="hidden" id="res-member-id">
            <div class="form-group">
                <label data-i18n="search_books_field">Pretraži knjigu</label>
                <input type="text" id="res-book-search" class="form-control" data-i18n-placeholder="book_author_placeholder" placeholder="Naslov ili autor..."
                       oninput="searchBooksForReservation()">
                <div id="res-book-results" style="max-height:150px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;margin-top:4px"></div>
            </div>
            <div class="form-group">
                <label data-i18n="search_member_field">Pretraži člana</label>
                <input type="text" id="res-member-search" class="form-control" data-i18n-placeholder="member_number_placeholder" placeholder="Ime ili broj člana..."
                       oninput="searchMembersForReservation()">
                <div id="res-member-results" style="max-height:150px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;margin-top:4px"></div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('new-reservation-modal')" data-i18n="cancel">Otkaži</button>
                <button type="submit" class="btn btn-primary" data-i18n="reserve_book">Rezerviši</button>
            </div>
        </form>
    </div>
</div>

<script>
async function searchBooksForReservation() {
    const q = document.getElementById('res-book-search').value;
    if (q.length < 2) return;
    const res = await apiFetch(`/books?q=${encodeURIComponent(q)}&per_page=10`);
    const books = await res.json();
    document.getElementById('res-book-results').innerHTML = books.map(b => `
        <div style="padding:8px;cursor:pointer;border-bottom:1px solid var(--border)"
             onclick="document.getElementById('res-book-id').value=${b.id};document.getElementById('res-book-search').value='${b.title} — ${b.author}';document.getElementById('res-book-results').innerHTML=''">
            <strong>${b.title}</strong> — ${b.author}
        </div>
    `).join('');
}
async function searchMembersForReservation() {
    const q = document.getElementById('res-member-search').value;
    if (q.length < 2) return;
    const res = await apiFetch(`/members?q=${encodeURIComponent(q)}&per_page=10`);
    const members = await res.json();
    document.getElementById('res-member-results').innerHTML = members.map(m => `
        <div style="padding:8px;cursor:pointer;border-bottom:1px solid var(--border)"
             onclick="document.getElementById('res-member-id').value=${m.id};document.getElementById('res-member-search').value='${m.first_name} ${m.last_name} (${m.member_number})';document.getElementById('res-member-results').innerHTML=''">
            <strong>${m.first_name} ${m.last_name}</strong> (${m.member_number})
        </div>
    `).join('');
}
</script>
{% endblock %}

{% block scripts %}
<script>initReservationsPage();</script>
{% endblock %}
